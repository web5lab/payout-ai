# User-Centric Schema for Complete Offering Ecosystem

# ============================================
# USER ENTITIES (Main Focus)
# ============================================

type User @entity {
  id: Bytes! # user address
  address: Bytes!
  
  # Investment Activity
  totalInvestments: BigInt!
  totalInvestmentVolume: BigInt! # USD value
  totalTokensReceived: BigInt!
  totalTokensClaimed: BigInt!
  
  # Payout Activity
  totalPayoutsReceived: BigInt!
  totalPayoutsClaimed: BigInt!
  activeWrappedTokens: BigInt!
  
  # Emergency Activity
  totalEmergencyUnlocks: BigInt!
  totalPenaltiesPaid: BigInt!
  
  # Offering Creation (if user is a creator)
  totalOfferingsCreated: BigInt!
  totalFundsRaised: BigInt! # As offering creator
  
  # Timestamps
  firstActivityAt: BigInt!
  lastActivityAt: BigInt!
  
  # Derived relationships
  investments: [UserInvestment!]! @derivedFrom(field: "user")
  claims: [UserClaim!]! @derivedFrom(field: "user")
  payouts: [UserPayout!]! @derivedFrom(field: "user")
  wrappedTokenHoldings: [UserWrappedTokenHolding!]! @derivedFrom(field: "user")
  createdOfferings: [Offering!]! @derivedFrom(field: "creator")
  emergencyUnlocks: [UserEmergencyUnlock!]! @derivedFrom(field: "user")
  refunds: [UserRefund!]! @derivedFrom(field: "user")
  kybValidations: [UserKYBValidation!]! @derivedFrom(field: "user")
  notifications: [UserNotification!]! @derivedFrom(field: "user")
  activityHistory: [UserActivityHistory!]! @derivedFrom(field: "user")
}

# ============================================
# USER INVESTMENT TRACKING
# ============================================

type UserInvestment @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  user: User!
  userAddress: Bytes!
  
  # Investment Details
  offering: Offering!
  offeringAddress: Bytes!
  paymentToken: Bytes!
  paymentTokenSymbol: String
  paidAmount: BigInt!
  usdValue: BigInt!
  tokensReceived: BigInt!
  
  # Investment Type
  isKYBValidated: Boolean!
  isNativeETH: Boolean!
  
  # Wrapped Token Info (if APY enabled)
  hasWrappedTokens: Boolean!
  wrappedTokenAddress: Bytes
  wrappedTokensReceived: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  gasUsed: BigInt!
  gasPrice: BigInt!
}

type UserClaim @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  user: User!
  userAddress: Bytes!
  
  # Claim Details
  offering: Offering
  offeringAddress: Bytes!
  claimType: String! # "investment_tokens", "wrapped_payout", "final_tokens", "refund", "emergency_unlock"
  amount: BigInt!
  tokenAddress: Bytes!
  tokenSymbol: String
  
  # Context
  isEmergencyUnlock: Boolean!
  penaltyAmount: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type UserPayout @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  user: User!
  userAddress: Bytes!
  
  # Payout Details
  wrappedToken: WrappedToken!
  wrappedTokenAddress: Bytes!
  amount: BigInt!
  payoutToken: Bytes!
  payoutTokenSymbol: String
  
  # Payout Context
  period: BigInt!
  isPartialClaim: Boolean!
  remainingClaimable: BigInt!
  
  # User's Share Info
  userWrappedBalance: BigInt!
  totalWrappedSupply: BigInt!
  sharePercentage: BigInt! # basis points (10000 = 100%)
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type UserWrappedTokenHolding @entity {
  id: Bytes! # userAddress-wrappedTokenAddress
  user: User!
  userAddress: Bytes!
  wrappedToken: WrappedToken!
  wrappedTokenAddress: Bytes!
  
  # Holdings Info
  currentBalance: BigInt!
  originalInvestment: BigInt!
  usdValueInvested: BigInt!
  
  # Payout Info
  totalPayoutsReceived: BigInt!
  totalPayoutsClaimed: BigInt!
  currentClaimablePayouts: BigInt!
  lastClaimedPeriod: BigInt!
  
  # Status
  isActive: Boolean!
  hasClaimedFinal: Boolean!
  hasEmergencyUnlocked: Boolean!
  
  # Timestamps
  firstInvestmentAt: BigInt!
  lastActivityAt: BigInt!
}

type UserEmergencyUnlock @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  user: User!
  userAddress: Bytes!
  wrappedToken: WrappedToken!
  wrappedTokenAddress: Bytes!
  
  # Emergency Unlock Details
  originalAmount: BigInt!
  penaltyAmount: BigInt!
  receivedAmount: BigInt!
  penaltyPercentage: BigInt! # basis points
  totalPayoutsClaimedBefore: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  unlockedAt: BigInt!
}

type UserRefund @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  user: User!
  userAddress: Bytes!
  offering: Offering!
  offeringAddress: Bytes!
  
  # Refund Details
  amount: BigInt!
  token: Bytes!
  tokenSymbol: String
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type UserKYBValidation @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  user: User!
  userAddress: Bytes!
  
  # KYB Details
  validator: Bytes!
  signatureHash: Bytes!
  
  # Associated Investment
  investment: UserInvestment
  offeringAddress: Bytes!
  investmentAmount: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# ============================================
# OFFERING ENTITIES
# ============================================

type Offering @entity {
  id: Bytes! # offering contract address
  creator: User!
  creatorAddress: Bytes!
  tokenOwner: Bytes!
  
  # Token Details
  saleToken: Bytes!
  saleTokenSymbol: String!
  
  # Investment Parameters
  minInvestment: BigInt!
  maxInvestment: BigInt!
  startDate: BigInt!
  endDate: BigInt!
  maturityDate: BigInt!
  fundraisingCap: BigInt!
  softCap: BigInt!
  tokenPrice: BigInt!
  
  # Configuration
  autoTransfer: Boolean!
  apyEnabled: Boolean!
  wrappedTokenAddress: Bytes
  payoutTokenAddress: Bytes
  payoutRate: BigInt!
  
  # Status
  isActive: Boolean!
  isFinalized: Boolean!
  isCancelled: Boolean!
  softCapReached: Boolean!
  
  # Statistics
  totalRaised: BigInt!
  totalInvestors: BigInt!
  totalTokensDistributed: BigInt!
  totalRefunded: BigInt!
  
  # Timestamps
  createdAt: BigInt!
  createdBlock: BigInt!
  finalizedAt: BigInt
  cancelledAt: BigInt
  
  # Derived relationships
  investments: [UserInvestment!]! @derivedFrom(field: "offering")
  claims: [UserClaim!]! @derivedFrom(field: "offering")
  refunds: [UserRefund!]! @derivedFrom(field: "offering")
  performance: OfferingPerformance @derivedFrom(field: "offering")
}

type OfferingPerformance @entity {
  id: Bytes! # offering address
  offering: Offering!
  offeringAddress: Bytes!
  
  # Investor Metrics
  totalInvestors: BigInt!
  averageInvestmentSize: BigInt!
  largestInvestment: BigInt!
  smallestInvestment: BigInt!
  
  # Timing Metrics
  raisedInFirst24Hours: BigInt!
  raisedInFirstWeek: BigInt!
  timeToSoftCap: BigInt!
  timeToHardCap: BigInt!
  
  # Success Metrics
  tokensClaimedPercentage: BigInt! # basis points
  refundedPercentage: BigInt! # basis points
  
  # Payout Metrics (if APY enabled)
  totalPayoutsDistributed: BigInt!
  averagePayoutPerUser: BigInt!
  emergencyUnlockRate: BigInt! # basis points
  
  # Last Updated
  lastUpdated: BigInt!
}

# ============================================
# WRAPPED TOKEN ENTITIES
# ============================================

type WrappedToken @entity {
  id: Bytes! # wrapped token contract address
  name: String!
  symbol: String!
  
  # Linked Contracts
  offering: Offering
  offeringAddress: Bytes!
  peggedToken: Bytes!
  payoutToken: Bytes!
  payoutTokenSymbol: String
  
  # Configuration
  maturityDate: BigInt!
  payoutAPR: BigInt!
  payoutPeriodDuration: BigInt!
  firstPayoutDate: BigInt!
  
  # Current State
  currentPayoutPeriod: BigInt!
  lastPayoutDistributionTime: BigInt!
  totalSupply: BigInt!
  totalEscrowed: BigInt!
  totalUSDTInvested: BigInt!
  
  # Payout Statistics
  totalPayoutFundsDistributed: BigInt!
  totalPayoutsClaimed: BigInt!
  currentPayoutFunds: BigInt!
  
  # Emergency Unlock
  emergencyUnlockEnabled: Boolean!
  emergencyUnlockPenalty: BigInt!
  totalEmergencyUnlocks: BigInt!
  
  # Holder Statistics
  totalHolders: BigInt!
  activeHolders: BigInt!
  
  # Timestamps
  createdAt: BigInt!
  createdBlock: BigInt!
  
  # Derived relationships
  holders: [UserWrappedTokenHolding!]! @derivedFrom(field: "wrappedToken")
  payouts: [UserPayout!]! @derivedFrom(field: "wrappedToken")
  emergencyUnlocks: [UserEmergencyUnlock!]! @derivedFrom(field: "wrappedToken")
  payoutDistributions: [PayoutDistribution!]! @derivedFrom(field: "wrappedToken")
}

type PayoutDistribution @entity(immutable: true) {
  id: Bytes! # wrappedTokenAddress-period-distribution
  wrappedToken: WrappedToken!
  wrappedTokenAddress: Bytes!
  
  # Distribution Details
  period: BigInt!
  amount: BigInt!
  totalUSDTAtDistribution: BigInt!
  distributedBy: Bytes!
  
  # Holder Info
  eligibleHolders: BigInt!
  totalEligibleBalance: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  distributedAt: BigInt!
}

type PayoutPeriod @entity {
  id: Bytes! # wrappedTokenAddress-period
  wrappedToken: WrappedToken!
  wrappedTokenAddress: Bytes!
  
  # Period Details
  periodNumber: BigInt!
  distributedAmount: BigInt!
  totalUSDTAtDistribution: BigInt!
  distributedAt: BigInt!
  distributedBy: Bytes!
  
  # Claim Statistics
  totalClaims: BigInt!
  totalClaimedAmount: BigInt!
  unclaimedAmount: BigInt!
  claimRate: BigInt! # basis points
  eligibleUsers: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# ============================================
# EVENT TRACKING ENTITIES
# ============================================

type InvestmentEvent @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  eventType: String! # "routed", "kyb_validated"
  investor: Bytes!
  offering: Bytes!
  paymentToken: Bytes!
  amount: BigInt!
  tokensReceived: BigInt!
  isKYBValidated: Boolean!
  isNativeETH: Boolean!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
  gasUsed: BigInt!
  gasPrice: BigInt!
}

type PayoutEvent @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  eventType: String! # "distributed", "claimed"
  wrappedToken: Bytes!
  user: Bytes
  amount: BigInt!
  period: BigInt!
  
  # Distribution Context
  totalUSDTAtDistribution: BigInt!
  eligibleHolders: BigInt!
  userBalance: BigInt!
  sharePercentage: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type EmergencyEvent @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  eventType: String! # "enabled", "disabled", "used"
  wrappedToken: Bytes!
  user: Bytes
  amount: BigInt!
  penalty: BigInt!
  penaltyPercentage: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type RefundEvent @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  eventType: String! # "enabled", "claimed"
  offering: Bytes!
  user: Bytes
  token: Bytes!
  amount: BigInt!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# ============================================
# DEPLOYMENT TRACKING
# ============================================

type OfferingDeployment @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  offeringId: BigInt!
  creator: User!
  creatorAddress: Bytes!
  offeringAddress: Bytes!
  tokenOwner: Bytes!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type WrappedTokenDeployment @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  tokenId: BigInt!
  creator: User!
  creatorAddress: Bytes!
  wrappedTokenAddress: Bytes!
  offeringContract: Bytes!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# ============================================
# DEPLOYMENT TRACKING
# ============================================

type OfferingDeployment @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  offeringId: BigInt!
  creator: User!
  creatorAddress: Bytes!
  offeringAddress: Bytes!
  tokenOwner: Bytes!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type WrappedTokenDeployment @entity(immutable: true) {
  id: Bytes! # txHash-logIndex
  tokenId: BigInt!
  creator: User!
  creatorAddress: Bytes!
  wrappedTokenAddress: Bytes!
  offeringContract: Bytes!
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# ============================================
# ANALYTICS ENTITIES
# ============================================

type GlobalStats @entity {
  id: Bytes! # "global"
  
  # User Statistics
  totalUsers: BigInt!
  activeInvestors: BigInt!
  totalCreators: BigInt!
  
  # Offering Statistics
  totalOfferings: BigInt!
  activeOfferings: BigInt!
  totalOfferingVolume: BigInt!
  
  # Investment Statistics
  totalInvestments: BigInt!
  totalInvestmentVolume: BigInt!
  
  # Wrapped Token Statistics
  totalWrappedTokens: BigInt!
  activeWrappedTokens: BigInt!
  totalWrappedTokenHolders: BigInt!
  
  # Payout Statistics
  totalPayoutDistributions: BigInt!
  totalPayoutVolume: BigInt!
  totalPayoutsClaimed: BigInt!
  
  # Emergency Statistics
  totalEmergencyUnlocks: BigInt!
  totalPenaltiesPaid: BigInt!
  
  # Refund Statistics
  totalRefunds: BigInt!
  totalRefundVolume: BigInt!
  
  # KYB Statistics
  totalKYBValidations: BigInt!
  kybValidatedInvestments: BigInt!
  
  # Last Updated
  lastUpdated: BigInt!
}

type UserDailyStats @entity {
  id: Bytes! # userAddress-YYYY-MM-DD
  user: User!
  userAddress: Bytes!
  date: String! # YYYY-MM-DD format
  
  # Daily Activity
  investmentsCount: BigInt!
  investmentVolume: BigInt!
  claimsCount: BigInt!
  claimedAmount: BigInt!
  payoutsCount: BigInt!
  payoutAmount: BigInt!
  
  # Cumulative Stats (as of this date)
  totalInvestmentVolume: BigInt!
  totalTokensHeld: BigInt!
  totalPayoutsReceived: BigInt!
}

type UserMonthlyStats @entity {
  id: Bytes! # userAddress-YYYY-MM
  user: User!
  userAddress: Bytes!
  yearMonth: String! # YYYY-MM format
  
  # Monthly Activity
  investmentsCount: BigInt!
  investmentVolume: BigInt!
  claimsCount: BigInt!
  claimedAmount: BigInt!
  payoutsCount: BigInt!
  payoutAmount: BigInt!
  
  # Monthly Averages
  avgInvestmentSize: BigInt!
  avgPayoutSize: BigInt!
}

type DailySystemStats @entity {
  id: Bytes! # YYYY-MM-DD
  date: String! # YYYY-MM-DD format
  
  # Daily New Activity
  newUsers: BigInt!
  newOfferings: BigInt!
  newWrappedTokens: BigInt!
  newInvestments: BigInt!
  
  # Daily Volume
  investmentVolume: BigInt!
  payoutDistributions: BigInt!
  payoutVolume: BigInt!
  payoutClaims: BigInt!
  emergencyUnlocks: BigInt!
  emergencyVolume: BigInt!
  refunds: BigInt!
  refundVolume: BigInt!
  
  # Cumulative Totals (as of this date)
  totalUsers: BigInt!
  totalOfferings: BigInt!
  totalInvestmentVolume: BigInt!
}

# ============================================
# NOTIFICATION SYSTEM
# ============================================

type UserNotification @entity {
  id: Bytes! # userAddress-timestamp-type
  user: User!
  userAddress: Bytes!
  
  # Notification Details
  notificationType: String! # "payout_available", "maturity_approaching", "emergency_enabled", etc.
  title: String!
  message: String!
  priority: String! # "low", "medium", "high", "urgent"
  
  # Status
  isRead: Boolean!
  isActionable: Boolean!
  
  # Context
  relatedOffering: Bytes
  relatedWrappedToken: Bytes
  relatedAmount: BigInt
  
  # Timestamps
  createdAt: BigInt!
  readAt: BigInt
  expiresAt: BigInt
}

type UserActivityHistory @entity(immutable: true) {
  id: Bytes! # txHash-logIndex-activityType
  user: User!
  userAddress: Bytes!
  
  # Activity Details
  activityType: String! # "investment", "claim", "payout", "emergency", "refund", "offering_created"
  description: String!
  amount: BigInt!
  
  # Context
  tokenAddress: Bytes
  offeringAddress: Bytes
  wrappedTokenAddress: Bytes
  
  # Transaction Info
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# ============================================
# UPCOMING PAYOUT PREDICTIONS
# ============================================

type UserUpcomingPayout @entity {
  id: Bytes! # userAddress-wrappedTokenAddress-nextPeriod
  user: User!
  userAddress: Bytes!
  wrappedToken: WrappedToken!
  wrappedTokenAddress: Bytes!
  
  # Prediction Details
  expectedPeriod: BigInt!
  expectedAmount: BigInt!
  expectedDate: BigInt!
  userBalance: BigInt!
  sharePercentage: BigInt!
  
  # Status
  isAvailable: Boolean!
  hasBeenClaimed: Boolean!
  
  # Timestamps
  calculatedAt: BigInt!
  lastUpdated: BigInt!
}